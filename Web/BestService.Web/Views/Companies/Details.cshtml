@model BestService.Web.ViewModels.Companies.CompanyDetailsViewModel
@{
    ViewData["Title"] = @Model.Name + " Details";

    void DisplayComments(int? parrentId)
    {
        var comments = Model.Comments.Where(x => x.ParrentId == parrentId);
        if (!comments.Any())
        {
            return;
        }

        @foreach (var comment in comments)
        {
            <ul class="comment-list">
                <li class="comment">
                    <div class="vcard bio">
                        <img src="/images/person_1.jpg" alt="Image placeholder">
                    </div>
                    <div class="comment-body">
                        <h3>@comment.UserUserName</h3>
                        <div class="meta mb-2"><time datetime="@Model.CreatedOn.ToString("O")"></time></div>
                        <p>@Html.Raw(comment.SanitizedContent)</p>
                        <p><a class="reply" onclick="showAddCommentForm(@comment.Id)">Reply</a></p>
                        @{ DisplayComments(comment.Id); }
                    </div>
                </li>
            </ul>
        }
    }
}


<section class="hero-wrap hero-wrap-2" style="background-image: url('../images/bg_1.jpg');">
    <div class="overlay"></div>
    <div class="container">
        <div class="row no-gutters slider-text align-items-center justify-content-center">
            <div class="col-md-9 ftco-animate text-center">
                <h1 class="mb-2 bread">@ViewData["Title"]</h1>
                <p class="breadcrumbs"><span class="mr-2"><a href="/">Home <i class="ion-ios-arrow-forward"></i></a></span> <span class="mr-2"><a href="/get">Company <i class="ion-ios-arrow-forward"></i></a></span> <span> @ViewData["Title"] <i class="ion-ios-arrow-forward"></i></span></p>
            </div>
        </div>
    </div>
</section>

<section class="ftco-section">
    <div class="container">
        <div class="row">
            <form id="visit" method="post">
                <input name="company-id" type="hidden" value="@Model.Id" />
            </form>
            <div class="col-lg-8 ftco-animate">
                @{
                    if (TempData.ContainsKey("Edited"))
                    {
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>Successfully edited!</strong>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        TempData.Remove("Edited");
                    }
                }
                <!-- the actual blog post: title/author/date/content -->
                <h2 class="mb-3">@Model.Name</h2>
                <p class="lead">
                    <i class="fa fa-user"></i> by <a href="">@Model.UserUsername</a>
                    <span class="float-right"><i class="text-info fa fa-star"></i> </span>
                    <span class="float-right"><i class="text-warning fa fa-star"></i> </span>
                    <span class="float-right"><i class="text-warning fa fa-star"></i> </span>
                    <span class="float-right"><i class="text-warning fa fa-star"></i> </span>
                    <span class="float-right"><i class="text-warning fa fa-star"></i> </span>
                    <span class="float-right mb-3">rating: </span>
                </p>
                <hr>

                <div>
                    <p>
                        <img src="@Model.ImageUri" alt="@Model.Name" class="img-fluid">
                    </p>
                </div>
                <div class="text-break">
                    <p>@Html.Raw(Model.SanitizedContent)</p>
                </div>

                <hr />

                <div class="container">
                    <div class="row">
                        <div class="col">
                            <small><i class="fa fa-calendar"></i> Created on: <time datetime="@Model.CreatedOn.ToString("O")"></time></small>
                        </div>
                        <div class="col-md-auto">
                            <small><i class="fa fa-comments"></i> Comments: @Model.Comments.Count()</small>
                        </div>
                        <div class="col col-lg-2">
                            <small>
                                <span><i class="icon-eye"></i><span id="AjaxViews"> Views: @Model.Visit</span>
                            </small>
                            @*<span><i class="fa fa-tags"></i> Tags: <a href=""><span class="badge badge-info">Bootstrap</span></a> <a href=""><span class="badge badge-info">Web</span></a> <a href=""><span class="badge badge-info">CSS</span></a> <a href=""><span class="badge badge-info">HTML</span></a></span>*@
                        </div>
                    </div>
                </div>
                <div class="tag-widget post-tag-container mb-5 mt-5">
                    <div class="tagcloud">
                        <a href="#" class="tag-cloud-link">Life</a>
                        <a href="#" class="tag-cloud-link">Sport</a>
                        <a href="#" class="tag-cloud-link">Tech</a>
                        <a href="#" class="tag-cloud-link">Travel</a>
                    </div>
                </div>

                @*<input id="showAddCommentForm" type="submit" value="Leave a comment" class="btn btn-primary btn-lg btn-block">*@
                @*<button id="showAddCommentForm(0)" type="button" class="btn btn-primary btn-lg btn-block">Leave a comment</button>*@
                <div class="tag-widget post-tag-container mb-5 mt-5"> <button type="button" class="btn btn-primary btn-lg btn-block" onclick="showAddCommentForm(0)">Leave a comment</button> </div>

                <div class="pt-2 mt-2">
                    @{DisplayComments(null);}
                </div>

                <script src="/lib/tinymce/tinymce.min.js" type="text/javascript"></script>
                <script type="text/javascript">
                    tinymce.init({
                        selector: "textarea",
                        plugins: ["image paste table link code media"]
                    });
                </script>
                <div class="comment-form-wrap pt-5">
                    <form asp-controller="Comments" asp-action="Create" method="post" id="AddCommentForm" style="display:none" class="p-5 bg-light">
                        <input type="hidden" name="CompanyId" value="@this.Model.Id" />
                        <input type="hidden" name="ParentId" value="0" />
                        <div>
                            <label asp-for="Rating"></label>
                            <input asp-for="Rating" min="1" max="5" class="form-control" />
                            <span asp-validation-for="Rating" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label for="Content"></label>
                            <textarea name="Content" id="Content" class="form-control"></textarea>
                        </div>
                        <div class="form-group">
                            <input type="submit" value="Post Comment" class="btn py-3 px-4 btn-primary">
                        </div>
                    </form>
                </div>
            </div> <!-- .col-md-8 -->

            <div class="col-lg-4 sidebar ftco-animate">
                <div class="sidebar-box">
                    <form action="#" class="search-form">
                        <div class="form-group">
                            <span class="icon icon-search"></span>
                            <input type="text" class="form-control" placeholder="Type a keyword and hit enter">
                        </div>
                    </form>
                </div>

                <vc:side-bar></vc:side-bar>

                <vc:recent-companies count="3"></vc:recent-companies>

                <div class="sidebar-box ftco-animate">
                    <h3>Popular Articles</h3>
                    <div class="block-21 mb-4 d-flex">
                        <a class="blog-img mr-4" style="background-image: url(/images/image_1.jpg);"></a>
                        <div class="text">
                            <h3 class="heading"><a href="#">Even the all-powerful Pointing has no control about the blind texts</a></h3>
                            <div class="meta">
                                <div><a href="#"><span class="icon-calendar"></span> June 27, 2019</a></div>
                                <div><a href="#"><span class="icon-person"></span> Dave Lewis</a></div>
                                <div><a href="#"><span class="icon-chat"></span> 19</a></div>
                            </div>
                        </div>
                    </div>
                    <div class="block-21 mb-4 d-flex">
                        <a class="blog-img mr-4" style="background-image: url(/images/image_2.jpg);"></a>
                        <div class="text">
                            <h3 class="heading"><a href="#">Even the all-powerful Pointing has no control about the blind texts</a></h3>
                            <div class="meta">
                                <div><a href="#"><span class="icon-calendar"></span> June 27, 2019</a></div>
                                <div><a href="#"><span class="icon-person"></span> Dave Lewis</a></div>
                                <div><a href="#"><span class="icon-chat"></span> 19</a></div>
                            </div>
                        </div>
                    </div>
                    <div class="block-21 mb-4 d-flex">
                        <a class="blog-img mr-4" style="background-image: url(/images/image_3.jpg);"></a>
                        <div class="text">
                            <h3 class="heading"><a href="#">Even the all-powerful Pointing has no control about the blind texts</a></h3>
                            <div class="meta">
                                <div><a href="#"><span class="icon-calendar"></span> June 27, 2019</a></div>
                                <div><a href="#"><span class="icon-person"></span> Dave Lewis</a></div>
                                <div><a href="#"><span class="icon-chat"></span> 19</a></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-box ftco-animate">
                    <h3>Tag Cloud</h3>
                    <ul class="tagcloud m-0 p-0">
                        <a href="#" class="tag-cloud-link">School</a>
                        <a href="#" class="tag-cloud-link">Kids</a>
                        <a href="#" class="tag-cloud-link">Nursery</a>
                        <a href="#" class="tag-cloud-link">Daycare</a>
                        <a href="#" class="tag-cloud-link">Care</a>
                        <a href="#" class="tag-cloud-link">Kindergarten</a>
                        <a href="#" class="tag-cloud-link">Teacher</a>
                    </ul>
                </div>
            </div><!-- END COL -->
        </div>
    </div>
</section>

@section Scripts{
    <script type="text/javascript">
        function showAddCommentForm(parentId) {
            $("#AddCommentForm input[name='ParentId']").val(parentId);
            $("#AddCommentForm").show();
            $([document.documentElement, document.body]).animate({
                scrollTop: $("#AddCommentForm").offset().top
            }, 1000)
        };
        function increaseVisits() {
            var token = $("#visit input[name=__RequestVerificationToken]").val();
            var companyId = Number($("#visit input[name=company-id]").val());
            var json = { companyId: companyId };
            console.log(companyId);
            $.ajax({
                url: "/api/visits",
                type: "POST",
                data: JSON.stringify(json),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                headers: { 'X-CSRF-TOKEN': token },
                success: function (data) {
                    $('#AjaxViews').html(' Views: ' + data.visitCount);
                }
            })
        };
        document.body.onload = function () {
            increaseVisits();
        };
    </script>
}